<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Content Security Policy fÃ¶r sÃ¤kerhet -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https: data:; media-src 'self' https: blob:; frame-src 'self' https:; connect-src 'self' https:">
    <title>XOM TV â€“ Alla Iranska Kanaler (dec 2025)</title>
    <!-- HLS.js bibliotek fÃ¶r att spela m3u8 streams -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.10/dist/hls.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{
            font-family:Arial,sans-serif;
            background:#1a1a2e;
            color:white;
            display:flex;
            flex-direction:column;
            height:100vh;
            overflow:hidden;
        }
        .header{
            background:#16213e;
            padding:15px;
            text-align:center;
            border-bottom:4px solid #4ecdc4;
            position:relative;
            flex-shrink:0;
            display:flex;
            flex-direction:column;
            align-items:center;
        }
        .header-top {
            display:flex;
            align-items:center;
            justify-content:space-between;
            width:100%;
            position:relative;
            margin-bottom:8px;
        }
        .header h1{color:#4ecdc4;font-size:1.8em;margin:0;text-align:center;flex:1}
        .warning{color:#ffcc00;font-size:0.9em;margin-top:8px;text-align:center}
        
        /* Filter-knappar */
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
            width: 100%;
            max-width: 600px;
        }
        .filter-btn {
            background: #0f3460;
            color: white;
            border: 2px solid #4ecdc4;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        .filter-btn:hover {
            background: #4ecdc4;
            color: #012;
        }
        .filter-btn.active {
            background: #4ecdc4;
            color: #012;
            border-color: #4ecdc4;
        }
        
        .container{
            flex:1;
            display:flex;
            overflow:hidden;
        }
        .sidebar{
            width:340px;
            background:#0f3460;
            overflow-y:auto;
            padding:15px;
            flex-shrink:0;
        }
        .section{
            display: block; /* Alla sektioner visas frÃ¥n bÃ¶rjan */
        }
        .section.hidden {
            display: none !important;
        }
        .section h3{
            color:#4ecdc4;
            margin:25px 0 12px 0;
            font-size:1.2em;
            border-bottom:2px solid #4ecdc4;
            padding-bottom:6px;
            display: block;
        }
        .channel{
            background:#4ecdc4;
            color:#000;
            padding:10px 12px;
            margin:6px 0;
            border-radius:10px;
            cursor:pointer;
            font-weight:bold;
            transition:.18s;
            text-align:left;
            font-size:1em;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }
        .channel:hover{background:#45b7aa;transform:scale(1.02)}
        .channel.active{background:#e74c3c;color:white}
        .channel .label{flex:1;padding-right:8px}
        
        /* Karwan-lÃ¤nk stil */
        .channel.karwan-link {
            background: #8e44ad;
            color: white;
        }
        .channel.karwan-link:hover {
            background: #9b59b6;
        }
        
        /* HLS-kanaler stil */
        .channel.hls-channel {
            background: #3498db;
            color: white;
        }
        .channel.hls-channel:hover {
            background: #2980b9;
        }
        
        /* Web-lÃ¤nkar stil */
        .channel.web-link {
            background: #e67e22;
            color: white;
        }
        .channel.web-link:hover {
            background: #d35400;
        }
        
        .fav{
            background:transparent;
            border:none;
            font-size:1.1em;
            cursor:pointer;
            color:#012;
            padding:4px;
            line-height:1;
            min-width: 30px;
            min-height: 30px;
        }
        .fav.fav-active{color:#f5d259}
        .player-area{
            flex:1;
            background:#000;
            display:flex;
            flex-direction:column;
            min-height:0;
            overflow:hidden;
        }
        .player-header{
            background:#16213e;
            padding:12px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            flex-shrink:0;
        }
        .player-header h2{
            color:#4ecdc4;
            font-size:1.5em;
            margin:0;
            flex:1;
            text-align:center;
        }
        .player-controls {
            display:flex;
            gap:10px;
            align-items:center;
        }
        .pip-btn {
            background: #4ecdc4;
            color: #012;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
            min-height: 44px;
            min-width: 44px;
        }
        .pip-btn:hover {
            background: #45b7aa;
        }
        
        /* Video element styling */
        #videoPlayer {
            flex: 1;
            width: 100%;
            min-height: 0;
            background: #000;
        }
        
        /* Iframe fÃ¶r telewebion streams */
        #iframePlayer {
            flex: 1;
            width: 100%;
            border: none;
            min-height: 0;
            background: #000;
            display: none;
        }
        
        .player-container {
            flex: 1;
            display: flex;
            flex-direction:column;
            min-height: 0;
        }

        .menu-toggle{
            display:none;
            background:#4ecdc4;
            color:#012;
            border:none;
            padding:8px 12px;
            border-radius:6px;
            font-weight:bold;
            cursor:pointer;
            font-size:1em;
            z-index:1000;
            min-height: 44px;
        }

        /* Error overlay */
        .error-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
            padding: 20px;
            text-align: center;
        }
        
        .error-overlay.active {
            display: flex;
        }
        
        .error-overlay button {
            background: #4ecdc4;
            color: #012;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin-top: 15px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Loading spinner */
        .loading-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 5px solid #4ecdc4;
            border-top: 5px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 99;
        }
        
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .loading-spinner.active {
            display: block;
        }

        /* Screen reader only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        @media(max-width:900px){
            .container{
                flex-direction:column;
                height:auto;
                min-height:0;
            }

            .player-area{
                flex:0 0 auto;
                height:70vh !important;
                min-height:300px;
                max-height:calc(100vh - 30vh);
            }

            .sidebar{
                width:100%;
                height:30vh !important;
                min-height:200px;
                max-height:calc(100vh - 70vh);
                overflow-y:auto;
                padding:10px;
                position:relative;
                display:none;
            }

            .header{
                padding:12px 10px;
            }
            
            .header-top {
                flex-direction:row;
                align-items:center;
                justify-content:space-between;
                margin-bottom:5px;
            }
            
            .menu-toggle{
                display:inline-block;
                order:-1;
                margin-right:10px;
                padding:6px 10px;
                font-size:0.9em;
            }
            
            .header h1{
                font-size:1.3em;
                margin:0;
                text-align:center;
                flex:1;
            }
            
            .warning{
                font-size:0.75em;
                margin-top:5px;
                line-height:1.2;
            }
            
            .filter-buttons {
                gap: 5px;
                margin-top: 8px;
            }
            .filter-btn {
                padding: 6px 12px;
                font-size: 0.8em;
                flex: 1;
                min-width: calc(25% - 5px);
                text-align: center;
                min-height: 44px;
            }

            .player-header{
                padding:10px;
                flex-wrap:wrap;
            }
            
            .player-header h2{
                font-size:1.2em;
                margin-bottom:5px;
                order:1;
                width:100%;
                text-align:center;
            }
            
            .player-controls{
                order:2;
                justify-content:center;
                width:100%;
                gap:15px;
            }
            
            .pip-btn {
                padding: 6px 10px;
                font-size: 0.85em;
                margin: 0;
            }

            .sidebar .section h3{
                display:block;
                margin:12px 0 6px 0;
                font-size:1.1em;
                padding-bottom:4px;
                position:sticky;
                top:0;
                background:#0f3460;
                z-index:10;
            }

            .channel{
                margin:4px 0;
                padding:12px 10px;
                border-radius:8px;
                font-size:0.95em;
                min-height: 44px;
            }
        }

        @media(max-width:480px){
            .player-area{
                height:75vh !important;
                min-height:280px;
            }

            .sidebar{
                height:25vh !important;
                min-height:180px;
            }

            .header h1{
                font-size:1.2em;
            }
            
            .menu-toggle{
                padding:5px 8px;
                font-size:0.8em;
            }
            
            .filter-buttons {
                flex-wrap: wrap;
            }
            .filter-btn {
                font-size: 0.75em;
                padding: 5px 8px;
                min-width: calc(50% - 5px);
            }
            
            .player-header h2{
                font-size:1.1em;
            }
            
            .pip-btn {
                padding: 5px 8px;
                font-size: 0.8em;
            }
            
            .channel{
                padding:12px 9px;
                font-size:0.9em;
            }
        }

        @media(max-width:900px) and (orientation: landscape){
            .player-area{
                height:80vh !important;
                min-height:250px;
            }
            .sidebar{
                height:20vh !important;
                min-height:150px;
            }
            
            .header h1{
                font-size:1.1em;
            }
            
            .warning{
                font-size:0.7em;
            }
            
            .filter-btn {
                font-size: 0.7em;
                padding: 4px 6px;
            }
            
            .player-header h2{
                font-size:1em;
            }
        }
        
        .mobile-header-info {
            display:none;
        }
        
        @media(max-width:900px){
            .mobile-header-info {
                display:block;
                font-size:0.75em;
                color:#4ecdc4;
                margin-top:3px;
                text-align:center;
                font-style:italic;
            }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-top">
        <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Visa eller dÃ¶lj kanallista">
            ðŸ“º <span class="sr-only">Visa kanaler</span>
        </button>
        <h1>XOM TV</h1>
        <div style="width:80px"></div> <!-- Spacer for alignment -->
    </div>
    <p>Alla iranska TV-kanaler â€“ fungerar perfekt</p>
    <div class="filter-buttons">
        <button class="filter-btn active" onclick="filterChannels('all')">Alla kanaler</button>
        <button class="filter-btn" onclick="filterChannels('national')">1. Nationella kanaler</button>
        <button class="filter-btn" onclick="filterChannels('regional')">2. Regionala kanaler</button>
        <button class="filter-btn" onclick="filterChannels('kurdish')">3. Kurdiska kanaler</button>
        <button class="filter-btn" onclick="filterChannels('karwan')">4. Karwan TV</button>
    </div>
    <p class="warning">KÃ¶r via lokal server â†’ python -m http.server</p>
    <p class="mobile-header-info">Klicka pÃ¥ "Visa kanaler" fÃ¶r att vÃ¤lja kanal</p>
</div>

<div class="container">
    <div class="player-area">
        <div class="player-header">
            <h2 id="channelName">TV1</h2>
            <div class="player-controls">
                <button class="pip-btn" onclick="togglePictureInPicture(event)" aria-label="Aktivera bild-i-bild">ðŸ“º PiP</button>
                <button class="pip-btn" onclick="toggleFullscreen()" aria-label="Visa i fullskÃ¤rm">â›¶ FullskÃ¤rm</button>
                <button class="pip-btn" onclick="reloadPlayer()" aria-label="Ladda om spelaren">â†» Ladda om</button>
                <button class="pip-btn" onclick="toggleUserAgentMode()" aria-label="VÃ¤xla User-Agent lÃ¤ge" id="userAgentBtn">ðŸ“± UA: Auto</button>
            </div>
        </div>
        <div class="player-container">
            <div class="loading-spinner" id="loadingSpinner"></div>
            <div class="error-overlay" id="errorOverlay">
                <div id="errorMessage">Kunde inte ladda stream</div>
                <button onclick="retryCurrentStream()">FÃ¶rsÃ¶k igen</button>
                <button onclick="tryAlternativeStream()" style="margin-top: 10px; background: #e67e22;">Testa alternativ stream</button>
            </div>
            <video id="videoPlayer" controls playsinline>
                Din webblÃ¤sare stÃ¶der inte videoavspelning.
            </video>
            <iframe
                id="iframePlayer"
                src="https://m.telewebion.com/embed/live/tv1?autoplay=1&mute=0"
                allowfullscreen
                allow="autoplay *; encrypted-media *; picture-in-picture *; fullscreen *"
                loading="eager"
                sandbox="allow-scripts allow-same-origin allow-presentation allow-popups"
                title="TV-spelare"
                referrerpolicy="no-referrer-when-downgrade">
            </iframe>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="section" id="favSection">
            <h3>Favoriter</h3>
            <div id="favoritesList" style="color:#fff">Inga favoriter</div>
        </div>

        <div class="section" id="nationalSection">
            <h3>Nationella Kanaler</h3>
            <!-- Kanaler hÃ¤r - samma som tidigare -->
            <div class="channel active" onclick="load('tv1','TV1',this)">
                <span class="label">TV1</span>
                <button class="fav" onclick="toggleFav(event,'tv1','TV1',this)" aria-label="LÃ¤gg till favorit">â˜†</button>
            </div>
            <div class="channel" onclick="load('tv2','TV2',this)"><span class="label">TV2</span><button class="fav" onclick="toggleFav(event,'tv2','TV2',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('tv3','TV3',this)"><span class="label">TV3</span><button class="fav" onclick="toggleFav(event,'tv3','TV3',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('tv4','TV4',this)"><span class="label">TV4</span><button class="fav" onclick="toggleFav(event,'tv4','TV4',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('Tehran','Tehran',this)"><span class="label">Tehran</span><button class="fav" onclick="toggleFav(event,'Tehran','Tehran',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('nasim','NASIM',this)"><span class="label">NASIM</span><button class="fav" onclick="toggleFav(event,'nasim','NASIM',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('varzesh','VARZESH',this)"><span class="label">VARZESH (Sport)</span><button class="fav" onclick="toggleFav(event,'varzesh','VARZESH',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('irinn','IRINN / KHABAR',this)"><span class="label">IRINN / KHABAR</span><button class="fav" onclick="toggleFav(event,'irinn','IRINN / KHABAR',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('irinn2','KHABAR2',this)"><span class="label">KHABAR2</span><button class="fav" onclick="toggleFav(event,'irinn2','KHABAR2',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('ifilm','IFILM Farsi',this)"><span class="label">IFILM Farsi</span><button class="fav" onclick="toggleFav(event,'ifilm','IFILM Farsi',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel hls-channel" onclick="loadHLS('ifilmdari','IFILM Dari', 'https://live.presstv.ir/hls/ifilm2.m3u8', this)"><span class="label">IFILM Dari (HLS)</span><button class="fav" onclick="toggleFav(event,'ifilmdari','IFILM Dari',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel hls-channel" onclick="loadHLS('ifilmen','IFILM English', 'https://live.presstv.ir/hls/ifilmen.m3u8', this)"><span class="label">IFILM English (HLS)</span><button class="fav" onclick="toggleFav(event,'ifilmen','IFILM English',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel hls-channel" onclick="loadHLS('ifilmar','IFILM Arabic', 'https://live.presstv.ir/hls/ifilmar.m3u8', this)"><span class="label">IFILM Arabic (HLS)</span><button class="fav" onclick="toggleFav(event,'ifilmar','IFILM Arabic',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('tv1plus','TV1PLUS',this)"><span class="label">TV1PLUS</span><button class="fav" onclick="toggleFav(event,'tv1plus','TV1PLUS',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('omid','OMID',this)"><span class="label">OMID</span><button class="fav" onclick="toggleFav(event,'omid','OMID',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('namayesh','NAMAYESH',this)"><span class="label">NAMAYESH</span><button class="fav" onclick="toggleFav(event,'namayesh','NAMAYESH',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('mostanad','MOSTANAD',this)"><span class="label">MOSTANAD</span><button class="fav" onclick="toggleFav(event,'mostanad','MOSTANAD',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('hdtest','TAMASHA',this)"><span class="label">TAMASHA</span><button class="fav" onclick="toggleFav(event,'hdtest','TAMASHA',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('amouzesh','AMOOZESH',this)"><span class="label">AMOOZESH</span><button class="fav" onclick="toggleFav(event,'amouzesh','AMOOZESH',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('salamat','SALAMAT',this)"><span class="label">SALAMAT</span><button class="fav" onclick="toggleFav(event,'salamat','SALAMAT',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('ofogh','OFOGH',this)"><span class="label">OFOGH</span><button class="fav" onclick="toggleFav(event,'ofogh','OFOGH',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('quran','QURAN TV',this)"><span class="label">QURAN TV</span><button class="fav" onclick="toggleFav(event,'quran','QURAN TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('pooya','POOYA & JAVANAN',this)"><span class="label">POOYA & JAVANAN</span><button class="fav" onclick="toggleFav(event,'pooya','POOYA & JAVANAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('javaneh','JAVANEH / KOODAK+',this)"><span class="label">JAVANEH / KOODAK+</span><button class="fav" onclick="toggleFav(event,'javaneh','JAVANEH / KOODAK+',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('sepehr','SEPEHR',this)"><span class="label">SEPEHR</span><button class="fav" onclick="toggleFav(event,'sepehr','SEPEHR',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('faratar','FARATAR',this)"><span class="label">FARATAR</span><button class="fav" onclick="toggleFav(event,'faratar','FARATAR',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('nava','NAVA',this)"><span class="label">NAVA</span><button class="fav" onclick="toggleFav(event,'nava','NAVA',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('nama','NAMA',this)"><span class="label">NAMA</span><button class="fav" onclick="toggleFav(event,'nama','NAMA',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('iribu','ROYA',this)"><span class="label">ROYA</span><button class="fav" onclick="toggleFav(event,'iribu','ROYA',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('ara','ARA',this)"><span class="label">ARA</span><button class="fav" onclick="toggleFav(event,'ara','ARA',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('iraneman','IRANEMAN',this)"><span class="label">IRANEMAN</span><button class="fav" onclick="toggleFav(event,'iraneman','IRANEMAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('golkhane','GOLKHANE',this)"><span class="label">GOLKHANE</span><button class="fav" onclick="toggleFav(event,'golkhane','GOLKHANE',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('negarestan','NEGARESTAN',this)"><span class="label">NEGARESTAN</span><button class="fav" onclick="toggleFav(event,'negarestan','NEGARESTAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('karoon','KAROON',this)"><span class="label">KAROON</span><button class="fav" onclick="toggleFav(event,'karoon','KAROON',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('sport3','TELEWEBION',this)"><span class="label">TELEWEBION</span><button class="fav" onclick="toggleFav(event,'sport3','TELEWEBION',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('sport1','TELEWEBION1',this)"><span class="label">TELEWEBION1</span><button class="fav" onclick="toggleFav(event,'sport1','TELEWEBION1',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('sport3','TELEWEBION2',this)"><span class="label">TELEWEBION2</span><button class="fav" onclick="toggleFav(event,'sport3','TELEWEBION2',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('parseh','PARSEH',this)"><span class="label">PARSEH</span><button class="fav" onclick="toggleFav(event,'parseh','PARSEH',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('nesfejahan','NESFEJAHAN',this)"><span class="label">NESFEJAHAN</span><button class="fav" onclick="toggleFav(event,'nesfejahan','NESFEJAHAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('sarbedaran','SARBEDARAN',this)"><span class="label">SARBEDARAN</span><button class="fav" onclick="toggleFav(event,'sarbedaran','SARBEDARAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
        </div>

        <div class="section" id="regionalSection">
            <h3>Regionala Kanaler</h3>
            <!-- Regionala kanaler hÃ¤r - samma som tidigare -->
            <div class="channel" onclick="load('mahabad','MAHABAD',this)"><span class="label">MAHABAD</span><button class="fav" onclick="toggleFav(event,'mahabad','MAHABAD',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('kordestan','KORDESTAN',this)"><span class="label">KORDESTAN</span><button class="fav" onclick="toggleFav(event,'kordestan','KORDESTAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('zagros','KERMANSHAH',this)"><span class="label">KERMANSHAH</span><button class="fav" onclick="toggleFav(event,'zagros','KERMANSHAH',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('ilam','ILAM',this)"><span class="label">ILAM</span><button class="fav" onclick="toggleFav(event,'ilam','ILAM',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('bushehr','BOOSHEHR',this)"><span class="label">BOOSHEHR</span><button class="fav" onclick="toggleFav(event,'bushehr','BOOSHEHR',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('abadan','ABADAN',this)"><span class="label">ABADAN</span><button class="fav" onclick="toggleFav(event,'abadan','ABADAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('khalijefars','BANDARABBAS',this)"><span class="label">BANDARABBAS</span><button class="fav" onclick="toggleFav(event,'khalijefars','BANDARABBAS',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('khoozestan','AHVAZ',this)"><span class="label">AHVAZ</span><button class="fav" onclick="toggleFav(event,'khoozestan','AHVAZ',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('kish','KISH',this)"><span class="label">KISH</span><button class="fav" onclick="toggleFav(event,'kish','KISH',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('hamoon','ZAHEDAN',this)"><span class="label">ZAHEDAN</span><button class="fav" onclick="toggleFav(event,'hamoon','ZAHEDAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('alborz','ALBORZ',this)"><span class="label">ALBORZ</span><button class="fav" onclick="toggleFav(event,'alborz','ALBORZ',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('aftab','ARAK',this)"><span class="label">ARAK</span><button class="fav" onclick="toggleFav(event,'aftab','ARAK',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('semnan','SEMNAN',this)"><span class="label">SEMNAN</span><button class="fav" onclick="toggleFav(event,'semnan','SEMNAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('noor','QOM',this)"><span class="label">QOM</span><button class="fav" onclick="toggleFav(event,'noor','QOM',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('qazvin','QAZVIN',this)"><span class="label">QAZVIN</span><button class="fav" onclick="toggleFav(event,'qazvin','QAZVIN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('jahanbin','4Mahalebakhtiari',this)"><span class="label">4Mahalebakhtiari</span><button class="fav" onclick="toggleFav(event,'jahanbin','4Mahalebakhtiari',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('sina','HAMADAN',this)"><span class="label">HAMADAN</span><button class="fav" onclick="toggleFav(event,'sina','HAMADAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('aflak','LORESTAN',this)"><span class="label">LORESTAN</span><button class="fav" onclick="toggleFav(event,'aflak','LORESTAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('kerman','KERMAN',this)"><span class="label">KERMAN</span><button class="fav" onclick="toggleFav(event,'kerman','KERMAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('esfahan','ESFEHAN',this)"><span class="label">ESFEHAN</span><button class="fav" onclick="toggleFav(event,'esfahan','ESFEHAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('fars','FARS',this)"><span class="label">FARS</span><button class="fav" onclick="toggleFav(event,'fars','FARS',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('taban','YAZD',this)"><span class="label">YAZD</span><button class="fav" onclick="toggleFav(event,'taban','YAZD',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('dena','YASOOJ',this)"><span class="label">YASOOJ</span><button class="fav" onclick="toggleFav(event,'dena','YASOOJ',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('khavaran','KH.JONOBI',this)"><span class="label">KH.JONOBI</span><button class="fav" onclick="toggleFav(event,'khavaran','KH.JONOBI',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('atrak','KH.SHOMALI',this)"><span class="label">KK.SHOMALI</span><button class="fav" onclick="toggleFav(event,'atrak','KH.SHOMALI',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('khorasanrazavi','KH.RAZAVI',this)"><span class="label">KK.RAZAVI</span><button class="fav" onclick="toggleFav(event,'khorasanrazavi','KH.RAZAVI',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('sabz','GORGAN',this)"><span class="label">GORGAN</span><button class="fav" onclick="toggleFav(event,'sabz','GORGAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('tabarestan','MAZANDARAN',this)"><span class="label">MAZANDARAN</span><button class="fav" onclick="toggleFav(event,'tabarestan','MAZANDARAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('baran','GILAN',this)"><span class="label">GILAN</span><button class="fav" onclick="toggleFav(event,'baran','GILAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('sabalan','ARDABIL',this)"><span class="label">ARDABIL</span><button class="fav" onclick="toggleFav(event,'sabalan','ARDABIL',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('sahand','TABRIZ',this)"><span class="label">TABRIZ</span><button class="fav" onclick="toggleFav(event,'sahand','TABRIZ',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('azarbayjangharbi','URMIA',this)"><span class="label">URMIA</span><button class="fav" onclick="toggleFav(event,'azarbayjangharbi','URMIA',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="load('eshragh','ZANJAN',this)"><span class="label">ZANJAN</span><button class="fav" onclick="toggleFav(event,'eshragh','ZANJAN',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
        </div>

        <!-- Kurdiska kanaler -->
        <div class="section" id="kurdishSection">
            <h3>Kurdiska Kanaler</h3>
            <!-- Kurdiska kanaler hÃ¤r - samma som tidigare -->
            <div class="channel" onclick="loadHLS('zagros','Zagros', 'https://5a3ed7a72ed4b.streamlock.net/zagrostv/SMIL:myStream.smil/playlist.m3u8', this)"><span class="label">Zagros (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_zagros','Zagros',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('kanal8','Kanal8', 'https://live.channel8.com/Channel8-Kurdish/index.fmp4.m3u8', this)"><span class="label">Kanal8 (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_kanal8','Kanal8',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('rudaw','Rudaw', 'https://svs.itworkscdn.net/rudawlive/rudawlive.smil/playlist.m3u8', this)"><span class="label">Rudaw (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_rudaw','Rudaw',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('kurdnews','Kurdsat News', 'https://hlspackager.akamaized.net/live/DB/KURDSAT_NEWS/HLS/KURDSAT_NEWS.m3u8', this)"><span class="label">Kurdsat News (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_kurdnews','Kurdsat News',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('sterk','Sterk', 'https://5dab1db4b25fe.streamlock.net/sterk/sterktv/chunklist_w1084077249.m3u8', this)"><span class="label">Sterk (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_sterk','Sterk',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('nrt','NRT News', 'https://media.streambrothers.com:1936/8226/8226/playlist.m3u8', this)"><span class="label">NRT News (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_nrt','NRT News',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('4kurd','4 Kurd', 'https://4kuhls.persiana.live/hls/stream.m3u8', this)"><span class="label">4 Kurd (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_4kurd','4 Kurd',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel hls-channel" onclick="loadHLS('medmusic','Med Music', 'http://54.36.110.140/live3/live3.m3u8', this)"><span class="label">Med Music (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_medmusic','Med Music',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('aryen','Aryen', 'https://stream.aryen.tv/live/tv/chunklist_w189856026.m3u8', this)"><span class="label">Aryen (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_aryen','Aryen',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('cira','Cira', 'https://cira-tv.akamaized.net/hls/stream_0.m3u8', this)"><span class="label">Cira (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_cira','Cira',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('waar','Waar', 'https://live.kwikmotion.com/waarmedialive/waarmedia.smil/waarmediapublish/waarmedia_source/chunks.m3u8', this)"><span class="label">Waar (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_waar','Waar',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('rojava','Rojava', 'https://rojava-tv.akamaized.net/hls/rojava-tv.m3u8', this)"><span class="label">Rojava (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_rojava','Rojava',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('kurdhd','Kurdsat HD', 'https://hlspackager.akamaized.net/live/DB/KURDSAT_HD/HLS/KURDSAT_HD.m3u8', this)"><span class="label">Kurdsat HD (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_kurdhd','Kurdsat HD',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('kurdistantv','Kurdistan TV', 'https://5a3ed7a72ed4b.streamlock.net/live/SMIL:myStream.smil/playlist.m3u8', this)"><span class="label">Kurdistan TV (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_kurdistantv','Kurdistan TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('pdki','PDKI', 'https://cdn.northtelecom.org/KurdChannel.m3u8', this)"><span class="label">PDKI (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_pdki','PDKI',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('komala','Komala', 'https://live.tvkomala.com/live/komala/playlist.m3u8', this)"><span class="label">Komala (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_komala','Komala',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('gk','GK', 'https://live.host247.net/gk/gksat/playlist.m3u8', this)"><span class="label">GK (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_gk','GK',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('iribkurd','IRIB Kurdistan', 'https://lenz.splus.ir/PLTV/88888888/224/3221226647/index.m3u8', this)"><span class="label">IRIB Kurdistan (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_iribkurd','IRIB Kurdistan',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel web-link" onclick="openWebLink('Sahar TV', 'https://kurdish.sahartv.ir/live')"><span class="label">Sahar TV (Web)</span><button class="fav" onclick="toggleFav(event,'kurdish_sahar','Sahar TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel web-link" onclick="openWebLink('Ava TV', 'https://www.ava.news/livewatch')"><span class="label">Ava TV (Web)</span><button class="fav" onclick="toggleFav(event,'kurdish_avatv','Ava TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel web-link" onclick="openWebLink('UTV Hawler', 'https://utvhawler.net/index.htm')"><span class="label">UTV Hawler (Web)</span><button class="fav" onclick="toggleFav(event,'kurdish_uthawler','UTV Hawler',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('baxche','Baxche', 'https://5dcabf026b188.streamlock.net/afarinTV/livestream/playlist.m3u8', this)"><span class="label">Baxche (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_baxche','Baxche',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('afarinkids','Afarin Kids', 'https://65f16f0fdfc51.streamlock.net/afarinTV/livestream/playlist.m3u8', this)"><span class="label">Afarin Kids (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_afarinkids','Afarin Kids',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('zarokkurm','Zarok Kurmanci', 'https://zindikurmanci.zaroktv.com.tr/hls/0/stream.m3u8', this)"><span class="label">Zarok Kurmanci (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_zarokkurm','Zarok Kurmanci',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel" onclick="loadHLS('zaroksor','Zarok Sorani', 'https://zindisorani.zaroktv.com.tr/hls/stream.m3u8', this)"><span class="label">Zarok Sorani (HLS)</span><button class="fav" onclick="toggleFav(event,'kurdish_zaroksor','Zarok Sorani',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
        </div>

        <!-- Karwan TV kanaler -->
        <div class="section" id="karwanSection">
            <h3>Karwan TV Kanaler</h3>
            <!-- Karwan kanaler hÃ¤r - UPPDATERADE MED USER-AGENT STÃ–D -->
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Mmn News', 'https://karwan.tv/mmn-news.html')"><span class="label">Karwan Mmn News</span><button class="fav" onclick="toggleFav(event,'karwan_mmnnews','Karwan Mmn News',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Shams TV', 'https://karwan.tv/shams-tv.html')"><span class="label">Karwan Shams TV</span><button class="fav" onclick="toggleFav(event,'karwan_shamstv','Karwan Shams TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Rudaw TV', 'https://karwan.tv/rudaw-tv.html')"><span class="label">Karwan Rudaw TV</span><button class="fav" onclick="toggleFav(event,'karwan_rudawtv','Karwan Rudaw TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Channel 8', 'https://karwan.tv/channel-8.html')"><span class="label">Karwan Channel 8</span><button class="fav" onclick="toggleFav(event,'karwan_channel8','Karwan Channel 8',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan CPI TV', 'https://karwan.tv/cpi-tv.html')"><span class="label">Karwan CPI TV</span><button class="fav" onclick="toggleFav(event,'karwan_cpitv','Karwan CPI TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Duhok TV', 'https://karwan.tv/duhok-tv.html')"><span class="label">Karwan Duhok TV</span><button class="fav" onclick="toggleFav(event,'karwan_duhoktv','Karwan Duhok TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Geli Kurdistan TV', 'https://karwan.tv/geli-kurdistan-tv.html')"><span class="label">Karwan Geli Kurdistan TV</span><button class="fav" onclick="toggleFav(event,'karwan_gelikurdistan','Karwan Geli Kurdistan TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Kurdistan24 TV', 'https://karwan.tv/kurdistan24-tv.html')"><span class="label">Karwan Kurdistan24 TV</span><button class="fav" onclick="toggleFav(event,'karwan_kurdistan24tv','Karwan Kurdistan24 TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Nalia TV', 'https://karwan.tv/nalia-tv.html')"><span class="label">Karwan Nalia TV</span><button class="fav" onclick="toggleFav(event,'karwan_naliatv','Karwan Nalia TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Rojhelat TV', 'https://karwan.tv/rojhelat-tv.html')"><span class="label">Karwan Rojhelat TV</span><button class="fav" onclick="toggleFav(event,'karwan_rojhelattv','Karwan Rojhelat TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Slemani TV', 'https://karwan.tv/slemani-tv.html')"><span class="label">Karwan Slemani TV</span><button class="fav" onclick="toggleFav(event,'karwan_slemanitv','Karwan Slemani TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Xabir TV', 'https://karwan.tv/xabir-tv.html')"><span class="label">Karwan Xabir TV</span><button class="fav" onclick="toggleFav(event,'karwan_xabirtv','Karwan Xabir TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
            <div class="channel karwan-link" onclick="openKarwanLink('Karwan Kurdistan TV', 'https://karwan.tv/kurdistan-tv.html')"><span class="label">Karwan Kurdistan TV</span><button class="fav" onclick="toggleFav(event,'karwan_kurdistantv','Karwan Kurdistan TV',this)" aria-label="LÃ¤gg till favorit">â˜†</button></div>
        </div>
    </div>
</div>

<script>
    // ===================== KONFIGURATION =====================
    const FAV_KEY = 'xom_tv_favs_v1.0';
    const CACHE_KEY = 'xom_tv_stream_cache';
    const EVENTS_KEY = 'xom_tv_events';
    const STORAGE_VERSION = '1.0';
    
    // User-Agent lÃ¤gen
    const USER_AGENTS = {
        AUTO: 'auto',
        MOBILE: 'mobile',
        DESKTOP: 'desktop',
        SMART_TV: 'smart_tv',
        CUSTOM: 'custom'
    };
    
    const USER_AGENT_STRINGS = {
        MOBILE: [
            'Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Mobile/15E148 Safari/604.1',
            'Mozilla/5.0 (Linux; Android 12; SM-S901B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.88 Mobile Safari/537.36',
            'Mozilla/5.0 (iPad; CPU OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Mobile/15E148 Safari/604.1'
        ],
        DESKTOP: [
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.84 Safari/537.36',
            'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.84 Safari/537.36'
        ],
        SMART_TV: [
            'Mozilla/5.0 (SMART-TV; Linux; Tizen 6.0) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/4.0 Chrome/99.0.4844.88 Safari/537.36',
            'Mozilla/5.0 (WebOS; Linux/SmartTV) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.88 Safari/537.36 WebAppManager'
        ]
    };
    
    // Globala variabler
    let activeBtn = null;
    let pipActive = false;
    let currentFilter = 'all';
    let hlsPlayer = null;
    let currentPlayerType = 'iframe';
    let currentStream = null;
    let currentUserAgentMode = USER_AGENTS.AUTO;
    let resizeTimeout;
    let streamCache = new Map();
    let currentChannel = { id: 'tv1', name: 'TV1', type: 'iframe' };
    
    // ===================== INITIERING =====================
    document.addEventListener('DOMContentLoaded', () => {
        initApp();
    });
    
    function initApp() {
        // Ladda cache och instÃ¤llningar
        loadCache();
        loadSettings();
        
        // LÃ¤gg till dataset.id pÃ¥ alla kanaler
        document.querySelectorAll('.channel').forEach((ch, index) => {
            addChannelData(ch, index);
        });
        
        updateStarButtons();
        refreshFavoritesList();
        
        // Starta med TV1
        const initial = document.querySelector('.channel.active');
        if (initial) initial.click();
        
        // Hantera responsiv design
        handleResponsiveDesign();
        
        // Aktivera "Alla kanaler" filter som standard
        filterChannels('all');
        
        // LÃ¤gg till keyboard navigation
        setupKeyboardNavigation();
        
        // LÃ¤gg till resize debounce
        setupResizeHandler();
        
        // Starta service worker om mÃ¶jligt
        initServiceWorker();
        
        // SpÃ¥ra start
        trackEvent('app_start', {
            userAgent: navigator.userAgent,
            screen: `${window.innerWidth}x${window.innerHeight}`,
            platform: navigator.platform
        });
    }
    
    // ===================== USER-AGENT SYSTEM =====================
    function toggleUserAgentMode() {
        const modes = Object.values(USER_AGENTS);
        const currentIndex = modes.indexOf(currentUserAgentMode);
        const nextIndex = (currentIndex + 1) % modes.length;
        currentUserAgentMode = modes[nextIndex];
        
        const btn = document.getElementById('userAgentBtn');
        let label = '';
        
        switch(currentUserAgentMode) {
            case USER_AGENTS.AUTO:
                label = 'ðŸ“± UA: Auto';
                break;
            case USER_AGENTS.MOBILE:
                label = 'ðŸ“± UA: Mobile';
                break;
            case USER_AGENTS.DESKTOP:
                label = 'ðŸ–¥ï¸ UA: Desktop';
                break;
            case USER_AGENTS.SMART_TV:
                label = 'ðŸ“º UA: Smart TV';
                break;
            case USER_AGENTS.CUSTOM:
                label = 'âš™ï¸ UA: Custom';
                break;
        }
        
        btn.textContent = label;
        btn.setAttribute('aria-label', `User-Agent lÃ¤ge: ${currentUserAgentMode}`);
        
        // Spara instÃ¤llning
        saveSetting('userAgentMode', currentUserAgentMode);
        trackEvent('user_agent_change', { mode: currentUserAgentMode });
    }
    
    function getUserAgentString() {
        switch(currentUserAgentMode) {
            case USER_AGENTS.MOBILE:
                return USER_AGENT_STRINGS.MOBILE[0];
            case USER_AGENTS.DESKTOP:
                return USER_AGENT_STRINGS.DESKTOP[0];
            case USER_AGENTS.SMART_TV:
                return USER_AGENT_STRINGS.SMART_TV[0];
            case USER_AGENTS.CUSTOM:
                return getCustomUserAgent();
            case USER_AGENTS.AUTO:
            default:
                return navigator.userAgent;
        }
    }
    
    function getCustomUserAgent() {
        const saved = localStorage.getItem('xom_tv_custom_ua');
        return saved || USER_AGENT_STRINGS.MOBILE[0];
    }
    
    function openKarwanLink(name, url) {
        showLoading();
        
        const finalUrl = addCacheBuster(url);
        const userAgent = getUserAgentString();
        
        // Skapa en iframe med anpassad User-Agent
        const iframe = document.createElement('iframe');
        iframe.id = 'karwanPlayer';
        iframe.src = finalUrl;
        iframe.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
            z-index: 10000;
        `;
        iframe.allow = 'autoplay; fullscreen; picture-in-picture';
        iframe.allowFullscreen = true;
        iframe.referrerPolicy = 'no-referrer';
        
        // FÃ¶rsÃ¶k manipulera User-Agent genom att skapa en proxy-lÃ¤nk
        // Notera: I en riktig app skulle detta gÃ¶ras via en server-side proxy
        const proxyUrl = createKarwanProxyUrl(url, userAgent);
        
        // Skapa ett popup-fÃ¶nster med custom headers (om mÃ¶jligt)
        try {
            const features = 'width=1200,height=700,menubar=no,toolbar=no,location=no,status=no';
            const newWindow = window.open(proxyUrl || finalUrl, '_blank', features);
            
            if (newWindow) {
                // Inject custom User-Agent script
                setTimeout(() => {
                    try {
                        newWindow.document.title = `${name} - XOM TV`;
                        // HÃ¤r skulle vi kunna injecta CSS fÃ¶r att dÃ¶lja reklam
                        const antiAdStyle = `
                            div[class*="ad"], 
                            div[class*="Ad"], 
                            div[class*="AD"],
                            iframe[src*="ads"],
                            ins.adsbygoogle {
                                display: none !important;
                                visibility: hidden !important;
                                height: 0 !important;
                                width: 0 !important;
                                opacity: 0 !important;
                                pointer-events: none !important;
                            }
                            body {
                                overflow: auto !important;
                            }
                        `;
                        const style = newWindow.document.createElement('style');
                        style.textContent = antiAdStyle;
                        newWindow.document.head.appendChild(style);
                    } catch (e) {
                        console.log('Kan inte modifiera popup:', e);
                    }
                }, 1000);
                
                newWindow.focus();
                trackEvent('karwan_link_open', { name, url, userAgentMode: currentUserAgentMode });
            } else {
                // Fallback: Ã¶ppna i samma fÃ¶nster
                window.location.href = finalUrl;
            }
        } catch (e) {
            console.error('Fel vid Ã¶ppning av Karwan:', e);
            window.open(finalUrl, '_blank');
        }
        
        hideLoading();
        
        // StÃ¤ng sidebar pÃ¥ mobil
        if (window.innerWidth <= 900) {
            setTimeout(() => toggleSidebar(), 300);
        }
    }
    
    function createKarwanProxyUrl(originalUrl, userAgent) {
        // I en riktig implementation skulle detta vara en server-side endpoint
        // FÃ¶r nu skapar vi bara en enkel URL med parametrar
        const params = new URLSearchParams({
            url: originalUrl,
            ua: userAgent,
            timestamp: Date.now(),
            nocache: Math.random().toString(36).substr(2, 9)
        });
        
        return `/proxy?${params.toString()}`;
    }
    
    // ===================== FAVORITER =====================
    function getFavs() {
        try {
            const saved = localStorage.getItem(FAV_KEY);
            if (!saved) return [];
            
            const data = JSON.parse(saved);
            // Validera data
            if (Array.isArray(data) && data.length > 0) {
                return data;
            }
            return [];
        } catch (e) {
            console.error('Fel vid lÃ¤sning av favoriter:', e);
            return [];
        }
    }
    
    function saveFavs(arr) {
        try {
            localStorage.setItem(FAV_KEY, JSON.stringify(arr));
            // Skapa backup
            localStorage.setItem(`${FAV_KEY}_backup_${Date.now()}`, JSON.stringify(arr));
        } catch (e) {
            console.error('Fel vid sparande av favoriter:', e);
        }
    }
    
    function isFav(id) {
        return getFavs().includes(id);
    }
    
    function toggleFav(event, id, name, btn) {
        event.stopPropagation();
        const favs = getFavs();
        const idx = favs.indexOf(id);
        
        if (idx === -1) {
            favs.push(id);
            trackEvent('favorite_add', { id, name });
        } else {
            favs.splice(idx, 1);
            trackEvent('favorite_remove', { id, name });
        }
        
        saveFavs(favs);
        updateStarButtons();
        refreshFavoritesList();
    }
    
    function updateStarButtons() {
        document.querySelectorAll('.channel').forEach(ch => {
            const b = ch.querySelector('.fav');
            if (!b) return;
            
            const id = ch.dataset.id;
            if (id && isFav(id)) {
                b.textContent = 'â˜…';
                b.classList.add('fav-active');
                b.setAttribute('aria-label', 'Ta bort frÃ¥n favoriter');
            } else {
                b.textContent = 'â˜†';
                b.classList.remove('fav-active');
                b.setAttribute('aria-label', 'LÃ¤gg till favorit');
            }
        });
    }
    
    function refreshFavoritesList() {
        const list = document.getElementById('favoritesList');
        const favs = getFavs();
        
        if (!favs || favs.length === 0) {
            list.textContent = 'Inga favoriter';
            list.setAttribute('aria-label', 'Inga favoriter lagda');
            return;
        }
        
        list.innerHTML = '';
        list.setAttribute('aria-label', `${favs.length} favoriter`);
        
        favs.forEach(id => {
            let label = id;
            let channelEl = null;
            
            // Hitta matchande kanal
            channelEl = Array.from(document.querySelectorAll('.channel')).find(ch => {
                return ch.dataset.id === id;
            });
            
            if (channelEl) {
                label = channelEl.querySelector('.label')?.textContent.trim() || id;
            }
            
            const btn = document.createElement('button');
            btn.textContent = label;
            btn.style.cssText = `
                display: block;
                width: 100%;
                margin: 6px 0;
                padding: 8px;
                border-radius: 8px;
                border: none;
                background: #4ecdc4;
                color: #012;
                font-weight: bold;
                font-size: 0.9em;
                cursor: pointer;
                transition: background 0.2s;
                min-height: 44px;
            `;
            btn.onmouseover = () => btn.style.background = '#45b7aa';
            btn.onmouseout = () => btn.style.background = '#4ecdc4';
            btn.setAttribute('aria-label', `Spela favoritkanal: ${label}`);
            
            btn.onclick = () => {
                if (channelEl) {
                    channelEl.click();
                    trackEvent('favorite_play', { id, name: label });
                }
                // StÃ¤ng sidebar pÃ¥ mobil
                if (window.innerWidth <= 900) {
                    setTimeout(() => toggleSidebar(), 300);
                }
            };
            
            list.appendChild(btn);
        });
    }
    
    // ===================== FILTER SYSTEM =====================
    function filterChannels(filter) {
        currentFilter = filter;
        
        // Uppdatera filter-knappar
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Visa/dÃ¶lj sektioner
        const sections = {
            'nationalSection': filter === 'all' || filter === 'national',
            'regionalSection': filter === 'all' || filter === 'regional',
            'kurdishSection': filter === 'all' || filter === 'kurdish',
            'karwanSection': filter === 'all' || filter === 'karwan',
            'favSection': true
        };
        
        for (const [sectionId, shouldShow] of Object.entries(sections)) {
            const section = document.getElementById(sectionId);
            if (section) {
                if (shouldShow) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            }
        }
        
        trackEvent('filter_change', { filter });
    }
    
    // ===================== PLAYER SYSTEM =====================
    async function load(id, name, btn) {
        showLoading();
        hideError();
        
        currentChannel = { id, name, type: 'iframe' };
        trackEvent('channel_load', currentChannel);
        
        const videoPlayer = document.getElementById('videoPlayer');
        const iframePlayer = document.getElementById('iframePlayer');
        const nameEl = document.getElementById('channelName');
        
        // Stoppa HLS om aktiv
        if (hlsPlayer) {
            hlsPlayer.destroy();
            hlsPlayer = null;
        }
        
        // Kolla cache fÃ¶rst
        const cacheKey = `stream_${id}`;
        if (streamCache.has(cacheKey)) {
            const cached = streamCache.get(cacheKey);
            if (Date.now() - cached.timestamp < 300000) { // 5 minuter cache
                loadCachedStream(cached);
                return;
            }
        }
        
        // Testa olika streams
        const streams = [
            `https://m.telewebion.com/embed/live/${id}?autoplay=1&mute=0`,
            `https://live.irib.ir/${id}`,
            `https://stream.irib.tv/${id}`,
            `https://telewebion.com/live/${id}`
        ];
        
        let success = false;
        for (const streamUrl of streams) {
            try {
                if (await testStream(streamUrl)) {
                    await loadStream(streamUrl, name, btn, 'iframe');
                    success = true;
                    
                    // Spara i cache
                    streamCache.set(cacheKey, {
                        url: streamUrl,
                        type: 'iframe',
                        timestamp: Date.now()
                    });
                    saveCache();
                    
                    break;
                }
            } catch (e) {
                console.log(`Stream misslyckades: ${streamUrl}`, e);
            }
        }
        
        if (!success) {
            showError('Kunde inte hitta en fungerande stream');
            trackEvent('stream_error', { id, name, error: 'No working streams found' });
        }
        
        hideLoading();
    }
    
    async function loadHLS(id, name, url, btn) {
        showLoading();
        hideError();
        
        currentChannel = { id, name, type: 'hls', url };
        trackEvent('channel_load', currentChannel);
        
        // Validera URL
        if (!url || !url.startsWith('http')) {
            showError('Ogiltig HLS URL');
            hideLoading();
            return;
        }
        
        const videoPlayer = document.getElementById('videoPlayer');
        const iframePlayer = document.getElementById('iframePlayer');
        const nameEl = document.getElementById('channelName');
        
        // DÃ¶lj iframe, visa video
        iframePlayer.style.display = 'none';
        iframePlayer.src = 'about:blank';
        videoPlayer.style.display = 'block';
        
        nameEl.textContent = name + ' (HLS)';
        currentPlayerType = 'hls';
        
        // Stoppa tidigare HLS
        if (hlsPlayer) {
            hlsPlayer.destroy();
            hlsPlayer = null;
        }
        
        // Kolla cache
        const cacheKey = `hls_${id}`;
        if (streamCache.has(cacheKey)) {
            const cached = streamCache.get(cacheKey);
            if (Date.now() - cached.timestamp < 300000) {
                url = cached.url; // AnvÃ¤nd cachad URL
            }
        }
        
        // Initiera HLS-spelare med timeout
        const loadTimeout = setTimeout(() => {
            if (hlsPlayer && hlsPlayer.buffered.length === 0) {
                console.warn('HLS timeout, fÃ¶rsÃ¶ker alternativa lÃ¤nkar...');
                tryAlternativeHLS(id, name, url, btn);
            }
        }, 15000);
        
        if (Hls.isSupported()) {
            hlsPlayer = new Hls({
                enableWorker: true,
                lowLatencyMode: true,
                backBufferLength: 90,
                maxBufferLength: 30,
                maxMaxBufferLength: 60,
                liveSyncDurationCount: 3,
                liveMaxLatencyDurationCount: 10
            });
            
            hlsPlayer.loadSource(url);
            hlsPlayer.attachMedia(videoPlayer);
            
            hlsPlayer.on(Hls.Events.MANIFEST_PARSED, () => {
                clearTimeout(loadTimeout);
                videoPlayer.play().catch(e => {
                    console.log('Autoplay blockerad:', e);
                    videoPlayer.controls = true;
                });
                
                // Spara i cache
                streamCache.set(cacheKey, {
                    url: url,
                    type: 'hls',
                    timestamp: Date.now()
                });
                saveCache();
                
                hideLoading();
                trackEvent('hls_success', { id, name });
            });
            
            hlsPlayer.on(Hls.Events.ERROR, (event, data) => {
                console.error('HLS error:', data);
                
                if (data.fatal) {
                    switch(data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.log('NÃ¤tverksfel, fÃ¶rsÃ¶ker igen...');
                            hlsPlayer.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.log('Mediafel, fÃ¶rsÃ¶ker Ã¥terstÃ¤lla...');
                            hlsPlayer.recoverMediaError();
                            break;
                        default:
                            console.log('Allvarligt HLS-fel, kan inte Ã¥terstÃ¤lla');
                            clearTimeout(loadTimeout);
                            hlsPlayer.destroy();
                            tryAlternativeHLS(id, name, url, btn);
                            break;
                    }
                }
            });
            
            // StÃ¶d fÃ¶r direktuppspelning (play/pause)
            videoPlayer.addEventListener('play', () => {
                trackEvent('video_play', { id, name });
            });
            
            videoPlayer.addEventListener('pause', () => {
                trackEvent('video_pause', { id, name });
            });
            
        } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
            // Safari stÃ¶der inbyggt HLS
            clearTimeout(loadTimeout);
            videoPlayer.src = url;
            videoPlayer.play().catch(e => {
                console.log('Autoplay blockerad:', e);
                videoPlayer.controls = true;
            });
            hideLoading();
        } else {
            clearTimeout(loadTimeout);
            showError('Din webblÃ¤sare stÃ¶der inte HLS-uppspelning. Prova med Chrome, Firefox eller Safari.');
            trackEvent('hls_unsupported', { id, name });
            hideLoading();
        }
        
        if (activeBtn) activeBtn.classList.remove('active');
        if (btn) {
            btn.classList.add('active');
            activeBtn = btn;
            scrollToChannel(btn);
        }
        
        updateMenuButton();
    }
    
    async function tryAlternativeHLS(id, name, originalUrl, btn) {
        console.log('Testar alternativa HLS-lÃ¤nkar...');
        
        // Lista med alternativa HLS-lÃ¤nkar (kan utÃ¶kas)
        const alternatives = [
            originalUrl,
            originalUrl.replace('https://', 'http://'),
            originalUrl.replace('.m3u8', '/playlist.m3u8'),
            originalUrl.replace('playlist.m3u8', 'chunklist.m3u8')
        ];
        
        for (const altUrl of alternatives) {
            if (altUrl === originalUrl) continue;
            
            try {
                if (await testStream(altUrl)) {
                    console.log(`Hittade alternativ stream: ${altUrl}`);
                    loadHLS(id + '_alt', name, altUrl, btn);
                    return;
                }
            } catch (e) {
                console.log(`Alternativ stream misslyckades: ${altUrl}`);
            }
        }
        
        showError('Inga fungerande HLS-streams tillgÃ¤ngliga');
        trackEvent('hls_all_failed', { id, name });
    }
    
    async function testStream(url) {
        try {
            const response = await fetch(url, { 
                method: 'HEAD',
                mode: 'no-cors',
                cache: 'no-cache'
            });
            return true;
        } catch (e) {
            // FÃ¶r CORS-fel, prova med GET istÃ¤llet
            try {
                const response = await fetch(url, { 
                    method: 'GET',
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                return true;
            } catch (e2) {
                return false;
            }
        }
    }
    
    function loadStream(url, name, btn, type) {
        const videoPlayer = document.getElementById('videoPlayer');
        const iframePlayer = document.getElementById('iframePlayer');
        const nameEl = document.getElementById('channelName');
        
        if (type === 'iframe') {
            // DÃ¶lj video, visa iframe
            videoPlayer.style.display = 'none';
            iframePlayer.style.display = 'block';
            iframePlayer.src = addCacheBuster(url);
            currentPlayerType = 'iframe';
        } else {
            // DÃ¶lj iframe, visa video
            iframePlayer.style.display = 'none';
            videoPlayer.style.display = 'block';
            videoPlayer.src = addCacheBuster(url);
            currentPlayerType = 'video';
        }
        
        nameEl.textContent = name;
        
        if (activeBtn) activeBtn.classList.remove('active');
        if (btn) {
            btn.classList.add('active');
            activeBtn = btn;
            scrollToChannel(btn);
        }
        
        updateMenuButton();
    }
    
    function loadCachedStream(cached) {
        const btn = document.querySelector(`.channel[data-id*="${cached.id}"]`);
        if (btn) {
            if (cached.type === 'iframe') {
                load(cached.id, cached.name, btn);
            } else {
                loadHLS(cached.id, cached.name, cached.url, btn);
            }
        }
    }
    
    // ===================== PLAYER CONTROLS =====================
    async function togglePictureInPicture(event) {
        const videoPlayer = document.getElementById('videoPlayer');
        const iframePlayer = document.getElementById('iframePlayer');
        const btn = event?.target || document.querySelector('.pip-btn');
        
        try {
            if (document.pictureInPictureElement) {
                await document.exitPictureInPicture();
                pipActive = false;
                btn.textContent = 'ðŸ“º PiP';
                btn.setAttribute('aria-label', 'Aktivera bild-i-bild');
                trackEvent('pip_exit');
            } else {
                if (currentPlayerType === 'hls' && !videoPlayer.paused) {
                    await videoPlayer.requestPictureInPicture();
                    pipActive = true;
                    btn.textContent = 'ðŸ–¥ï¸ Normal';
                    btn.setAttribute('aria-label', 'Avsluta bild-i-bild');
                    trackEvent('pip_enter', { type: 'hls' });
                } else if (currentPlayerType === 'iframe') {
                    // FÃ¶r iframe, Ã¶ppna i nytt fÃ¶nster
                    const popup = window.open(iframePlayer.src, '_blank', 'width=600,height=400');
                    if (popup) {
                        popup.focus();
                        trackEvent('pip_alternative', { type: 'iframe_popup' });
                    }
                }
            }
        } catch (e) {
            console.error('PiP error:', e);
            // Fallback: Ã¶ppna i nytt fÃ¶nster
            const url = currentPlayerType === 'hls' ? videoPlayer.src : iframePlayer.src;
            window.open(url, '_blank');
            trackEvent('pip_fallback', { error: e.message });
        }
    }
    
    function toggleFullscreen() {
        const videoPlayer = document.getElementById('videoPlayer');
        const iframePlayer = document.getElementById('iframePlayer');
        const container = document.querySelector('.player-container');
        
        const element = currentPlayerType === 'hls' ? videoPlayer : iframePlayer;
        
        if (!document.fullscreenElement) {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.mozRequestFullScreen) {
                element.mozRequestFullScreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
            trackEvent('fullscreen_enter');
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
            trackEvent('fullscreen_exit');
        }
    }
    
    function reloadPlayer() {
        if (currentPlayerType === 'hls' && hlsPlayer) {
            hlsPlayer.destroy();
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.load();
            if (currentChannel.url) {
                loadHLS(currentChannel.id, currentChannel.name, currentChannel.url, activeBtn);
            }
        } else if (currentPlayerType === 'iframe') {
            const iframePlayer = document.getElementById('iframePlayer');
            iframePlayer.src = iframePlayer.src;
        }
        trackEvent('player_reload');
    }
    
    // ===================== ERROR HANDLING =====================
    function showError(message) {
        const overlay = document.getElementById('errorOverlay');
        const messageEl = document.getElementById('errorMessage');
        
        messageEl.textContent = message;
        overlay.classList.add('active');
        
        // Auto-hide efter 10 sekunder
        setTimeout(() => {
            if (overlay.classList.contains('active')) {
                hideError();
            }
        }, 10000);
    }
    
    function hideError() {
        document.getElementById('errorOverlay').classList.remove('active');
    }
    
    function retryCurrentStream() {
        hideError();
        if (currentChannel.type === 'iframe') {
            load(currentChannel.id, currentChannel.name, activeBtn);
        } else {
            loadHLS(currentChannel.id, currentChannel.name, currentChannel.url, activeBtn);
        }
        trackEvent('stream_retry', currentChannel);
    }
    
    function tryAlternativeStream() {
        hideError();
        if (currentChannel.type === 'hls') {
            tryAlternativeHLS(currentChannel.id, currentChannel.name, currentChannel.url, activeBtn);
        } else {
            // FÃ¶r iframe, testa alternativa lÃ¤nkar
            load(currentChannel.id, currentChannel.name, activeBtn);
        }
        trackEvent('stream_alternative_try', currentChannel);
    }
    
    // ===================== LOADING STATE =====================
    function showLoading() {
        document.getElementById('loadingSpinner').classList.add('active');
    }
    
    function hideLoading() {
        document.getElementById('loadingSpinner').classList.remove('active');
    }
    
    // ===================== WEB LINKS =====================
    function openWebLink(name, url) {
        const finalUrl = addCacheBuster(url);
        const newWindow = window.open(finalUrl, '_blank', 'noopener,noreferrer,width=1200,height=700');
        
        if (newWindow) {
            newWindow.focus();
            trackEvent('web_link_open', { name, url });
        }
        
        if (window.innerWidth <= 900) {
            setTimeout(() => toggleSidebar(), 300);
        }
    }
    
    // ===================== SIDEBAR & UI =====================
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const playerArea = document.querySelector('.player-area');
        const btn = document.querySelector('.menu-toggle');
        const isMobile = window.innerWidth <= 900;
        
        if (sidebar.style.display === 'none' || sidebar.style.display === '') {
            sidebar.style.display = 'block';
            if (isMobile) {
                playerArea.style.height = '30vh';
                btn.textContent = 'âœ• StÃ¤ng lista';
                btn.setAttribute('aria-label', 'StÃ¤ng kanallista');
                scrollToChannel(activeBtn);
            }
        } else {
            sidebar.style.display = 'none';
            if (isMobile) {
                playerArea.style.height = '100vh';
                btn.textContent = 'ðŸ“º Visa kanaler';
                btn.setAttribute('aria-label', 'Visa kanallista');
            }
        }
        
        trackEvent('sidebar_toggle', { 
            state: sidebar.style.display === 'block' ? 'open' : 'closed',
            isMobile 
        });
    }
    
    function scrollToChannel(channel) {
        if (channel && window.innerWidth <= 900) {
            setTimeout(() => {
                channel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
    }
    
    function updateMenuButton() {
        if (window.innerWidth <= 900) {
            const btn = document.querySelector('.menu-toggle');
            const sidebar = document.getElementById('sidebar');
            
            if (sidebar.style.display === 'block') {
                btn.textContent = 'âœ• StÃ¤ng lista';
                btn.setAttribute('aria-label', 'StÃ¤ng kanallista');
            } else {
                btn.textContent = 'ðŸ“º Visa kanaler';
                btn.setAttribute('aria-label', 'Visa kanallista');
            }
        }
    }
    
    // ===================== KEYBOARD NAVIGATION =====================
    function setupKeyboardNavigation() {
        document.addEventListener('keydown', (e) => {
            // ESC - stÃ¤ng sidebar pÃ¥ mobil
            if (e.key === 'Escape') {
                if (window.innerWidth <= 900) {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar.style.display === 'block') {
                        toggleSidebar();
                    }
                }
            }
            
            // Piltangenter - navigera kanaler
            if (e.target === document.body || e.target.classList.contains('channel')) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateChannels('down');
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateChannels('up');
                }
            }
            
            // Space - play/pause video
            if (e.key === ' ' && e.target === document.body) {
                e.preventDefault();
                const videoPlayer = document.getElementById('videoPlayer');
                if (currentPlayerType === 'hls') {
                    if (videoPlayer.paused) {
                        videoPlayer.play();
                    } else {
                        videoPlayer.pause();
                    }
                }
            }
        });
    }
    
    function navigateChannels(direction) {
        const channels = Array.from(document.querySelectorAll('.channel:not(.hidden)'));
        const current = document.querySelector('.channel.active');
        let index = channels.indexOf(current);
        
        if (direction === 'down') {
            index = (index + 1) % channels.length;
        } else {
            index = (index - 1 + channels.length) % channels.length;
        }
        
        channels[index].click();
        channels[index].focus();
        trackEvent('keyboard_navigation', { direction, channel: channels[index].dataset.id });
    }
    
    // ===================== RESPONSIVE DESIGN =====================
    function handleResponsiveDesign() {
        const sidebar = document.getElementById('sidebar');
        const playerArea = document.querySelector('.player-area');
        const btn = document.querySelector('.menu-toggle');
        const isMobile = window.innerWidth <= 900;
        
        if (!isMobile) {
            sidebar.style.display = 'block';
            playerArea.style.height = 'auto';
            btn.style.display = 'none';
        } else {
            btn.style.display = 'inline-block';
            if (sidebar.style.display === 'none' || sidebar.style.display === '') {
                playerArea.style.height = '100vh';
                btn.textContent = 'ðŸ“º Visa kanaler';
            } else {
                playerArea.style.height = '30vh';
                btn.textContent = 'âœ• StÃ¤ng lista';
            }
        }
    }
    
    function setupResizeHandler() {
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                handleResponsiveDesign();
                trackEvent('window_resize', { 
                    width: window.innerWidth, 
                    height: window.innerHeight 
                });
            }, 250);
        });
    }
    
    // ===================== CACHE SYSTEM =====================
    function loadCache() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                streamCache = new Map(data);
            }
        } catch (e) {
            console.error('Fel vid lÃ¤sning av cache:', e);
        }
    }
    
    function saveCache() {
        try {
            // Spara endast senaste 50 cache-poster
            const entries = Array.from(streamCache.entries())
                .sort((a, b) => b[1].timestamp - a[1].timestamp)
                .slice(0, 50);
            
            localStorage.setItem(CACHE_KEY, JSON.stringify(entries));
        } catch (e) {
            console.error('Fel vid sparande av cache:', e);
        }
    }
    
    // ===================== SETTINGS =====================
    function loadSettings() {
        try {
            const mode = localStorage.getItem('xom_tv_user_agent_mode');
            if (mode && Object.values(USER_AGENTS).includes(mode)) {
                currentUserAgentMode = mode;
                updateUserAgentButton();
            }
        } catch (e) {
            console.error('Fel vid lÃ¤sning av instÃ¤llningar:', e);
        }
    }
    
    function saveSetting(key, value) {
        try {
            localStorage.setItem(`xom_tv_${key}`, value);
        } catch (e) {
            console.error('Fel vid sparande av instÃ¤llning:', e);
        }
    }
    
    function updateUserAgentButton() {
        const btn = document.getElementById('userAgentBtn');
        if (!btn) return;
        
        let label = '';
        switch(currentUserAgentMode) {
            case USER_AGENTS.AUTO: label = 'ðŸ“± UA: Auto'; break;
            case USER_AGENTS.MOBILE: label = 'ðŸ“± UA: Mobile'; break;
            case USER_AGENTS.DESKTOP: label = 'ðŸ–¥ï¸ UA: Desktop'; break;
            case USER_AGENTS.SMART_TV: label = 'ðŸ“º UA: Smart TV'; break;
            case USER_AGENTS.CUSTOM: label = 'âš™ï¸ UA: Custom'; break;
        }
        
        btn.textContent = label;
    }
    
    // ===================== UTILITY FUNCTIONS =====================
    function addChannelData(ch, index) {
        const onclickAttr = ch.getAttribute('onclick') || '';
        let id = ch.dataset.id;
        
        if (!id) {
            if (onclickAttr.includes('load(')) {
                const m = onclickAttr.match(/load\(['"]([^'"]+)['"]\s*,\s*['"]([^'"]+)['"]/);
                id = m ? m[1] : `channel_${index}`;
            } else if (onclickAttr.includes('loadHLS(')) {
                const m = onclickAttr.match(/loadHLS\(['"]([^'"]+)['"]\s*,\s*['"]([^'"]+)['"]/);
                id = m ? 'hls_' + m[1] : `hls_${index}`;
            } else if (onclickAttr.includes('openWebLink(')) {
                const m = onclickAttr.match(/openWebLink\(['"]([^'"]+)['"]/);
                id = m ? 'web_' + m[1].toLowerCase().replace(/[^a-z0-9]/g, '') : `web_${index}`;
            } else if (onclickAttr.includes('openKarwanLink(')) {
                const m = onclickAttr.match(/openKarwanLink\(['"]([^'"]+)['"]/);
                id = m ? 'karwan_' + m[1].toLowerCase().replace(/[^a-z0-9]/g, '') : `karwan_${index}`;
            } else {
                id = `channel_${index}`;
            }
        }
        
        ch.dataset.id = id;
        
        if (!ch.dataset.name) {
            const label = ch.querySelector('.label');
            if (label) {
                ch.dataset.name = label.textContent.trim();
            }
        }
    }
    
    function addCacheBuster(url) {
        if (!url) return url;
        const separator = url.includes('?') ? '&' : '?';
        return `${url}${separator}_=${Date.now()}&nocache=${Math.random().toString(36).substr(2, 9)}`;
    }
    
    // ===================== ANALYTICS =====================
    function trackEvent(eventName, data = {}) {
        try {
            const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
            events.push({
                event: eventName,
                data: data,
                timestamp: Date.now(),
                userAgent: navigator.userAgent,
                screen: `${window.innerWidth}x${window.innerHeight}`
            });
            
            // Spara max 1000 events
            if (events.length > 1000) {
                events.splice(0, events.length - 1000);
            }
            
            localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        } catch (e) {
            console.error('Fel vid spÃ¥rning:', e);
        }
    }
    
    // ===================== SERVICE WORKER =====================
    function initServiceWorker() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker registrerad:', registration);
                    trackEvent('service_worker_registered');
                })
                .catch(error => {
                    console.log('Service Worker registrering misslyckades:', error);
                    trackEvent('service_worker_failed', { error: error.message });
                });
        }
    }
    
    // ===================== GLOBAL EXPORTS =====================
    window.toggleFav = toggleFav;
    window.load = load;
    window.loadHLS = loadHLS;
    window.openWebLink = openWebLink;
    window.openKarwanLink = openKarwanLink;
    window.filterChannels = filterChannels;
    window.toggleSidebar = toggleSidebar;
    window.togglePictureInPicture = togglePictureInPicture;
    window.toggleFullscreen = toggleFullscreen;
    window.reloadPlayer = reloadPlayer;
    window.toggleUserAgentMode = toggleUserAgentMode;
    window.retryCurrentStream = retryCurrentStream;
    window.tryAlternativeStream = tryAlternativeStream;
    
    // StÃ¤ng sidebar vid klick utanfÃ¶r (mobil)
    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.querySelector('.menu-toggle');
        const isMobile = window.innerWidth <= 900;
        
        if (isMobile && sidebar.style.display === 'block') {
            if (!sidebar.contains(event.target) && 
                !menuBtn.contains(event.target) && 
                !event.target.classList.contains('channel') &&
                !event.target.closest('.channel')) {
                toggleSidebar();
            }
        }
    });
</script>

</body>
</html>
