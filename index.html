<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afarin Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dashjs/4.7.1/dash.all.min.js"></script>
    <style>
        body {
            background-color: #1a1a2e;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            margin: 0;
        }
        h1 {
            margin-bottom: 20px;
        }
        .player-container {
            width: 80%;
            max-width: 900px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
            background: #16213e;
            padding: 20px;
        }
        video {
            width: 100%;
            aspect-ratio: 16 / 9;
            border: none;
            border-radius: 10px;
            background: #000;
        }
        .info {
            margin-top: 15px;
            font-size: 14px;
            color: #aaa;
        }
        .timer {
            margin-top: 10px;
            padding: 10px;
            background-color: #0f3460;
            border-radius: 8px;
            font-size: 14px;
        }
        .timer span {
            color: #fbbf24;
            font-weight: bold;
            font-size: 16px;
        }
        .controls {
            margin-top: 15px;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin: 5px;
        }
        button:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body>
    <h1>Kanal: Afarin</h1>
    <div class="player-container">
        <video id="videoPlayer" controls autoplay></video>
        <div class="info">
            <p>MPEG-DASH Livestream</p>
        </div>
        <div class="timer">
            Token uppdateras om: <span id="countdown">18:00</span>
        </div>
        <div class="controls">
            <button onclick="manualRefresh()">üîÑ Uppdatera nu</button>
            <button onclick="toggleAutoRefresh()" id="toggleBtn">‚è∏Ô∏è Pausa auto-uppdatering</button>
        </div>
    </div>
    <script>
        const url = "https://live.karwan.tv/afarin-baxcha/index.mpd?token=a9b4a475b06a458df8f9164573ece1aea1d2d4ea-34dbf2cf88725025d68f9caf5a6badf0-1761866547-1761855747&remote=no_check_ip";
        const video = document.getElementById('videoPlayer');
        const player = dashjs.MediaPlayer().create();
        player.initialize(video, url, true);
        
        // Felhantering
        player.on(dashjs.MediaPlayer.events.ERROR, function(e) {
            console.error('Player error:', e);
            document.querySelector('.info p').textContent = 'Fel vid uppspelning. L√§nken kan ha g√•tt ut.';
        });

        // Auto-refresh efter 18 minuter (innan token g√•r ut efter 20 min)
        const REFRESH_TIME = 18 * 60 * 1000; // 18 minuter i millisekunder
        let nextRefresh = Date.now() + REFRESH_TIME;
        let autoRefreshEnabled = true;
        let countdownInterval;
        let refreshTimeout;

        // Funktion f√∂r att uppdatera nedr√§kningen
        function updateCountdown() {
            if (!autoRefreshEnabled) {
                document.getElementById('countdown').textContent = 'PAUSAD';
                return;
            }

            const timeLeft = Math.max(0, nextRefresh - Date.now());
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            document.getElementById('countdown').textContent = 
                minutes + ':' + seconds.toString().padStart(2, '0');
            
            if (timeLeft === 0) {
                clearInterval(countdownInterval);
            }
        }

        // Funktion f√∂r att ladda om sidan
        function refreshPage() {
            if (!autoRefreshEnabled) return;
            
            // Spara volyminst√§llningar
            localStorage.setItem('afarinVolume', video.volume);
            localStorage.setItem('afarinMuted', video.muted);
            
            console.log('Token uppdateras - laddar om sidan...');
            location.reload();
        }

        // Manuell uppdatering
        function manualRefresh() {
            clearTimeout(refreshTimeout);
            clearInterval(countdownInterval);
            refreshPage();
        }

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('toggleBtn');
            
            if (autoRefreshEnabled) {
                btn.textContent = '‚è∏Ô∏è Pausa auto-uppdatering';
                nextRefresh = Date.now() + REFRESH_TIME;
                refreshTimeout = setTimeout(refreshPage, REFRESH_TIME);
                countdownInterval = setInterval(updateCountdown, 1000);
            } else {
                btn.textContent = '‚ñ∂Ô∏è Aktivera auto-uppdatering';
                clearTimeout(refreshTimeout);
                clearInterval(countdownInterval);
            }
            updateCountdown();
        }

        // Starta nedr√§kning och schemal√§gg uppdatering
        refreshTimeout = setTimeout(refreshPage, REFRESH_TIME);
        countdownInterval = setInterval(updateCountdown, 1000);
        updateCountdown();

        // √Öterst√§ll volyminst√§llningar fr√•n tidigare session
        const savedVolume = localStorage.getItem('afarinVolume');
        const savedMuted = localStorage.getItem('afarinMuted');
        if (savedVolume) video.volume = parseFloat(savedVolume);
        if (savedMuted) video.muted = savedMuted === 'true';

        // Spara volym vid √§ndring
        video.addEventListener('volumechange', function() {
            localStorage.setItem('afarinVolume', video.volume);
            localStorage.setItem('afarinMuted', video.muted);
        });

        // Hantera sidsynlighet - ladda om om sidan varit inaktiv f√∂r l√§nge
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && autoRefreshEnabled) {
                if (Date.now() > nextRefresh) {
                    console.log('Sidan blev aktiv efter token-utg√•ng, laddar om...');
                    location.reload();
                }
            }
        });
    </script>
</body>
</html>
